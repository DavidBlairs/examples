---
title: ADRS
order: 4
---

The Response Analysis Dataset (`ADRS`) serves as a dataset in oncology clinical trials for monitoring disease response or progression and therapeutic efficacy. 

`ADRS` is structured to capture and organize data points pertinent to being able to subsequently derive common efficacy endpoints like Progression-Free Survival (PFS). PFS is a vital metric that measures the amount of time a patient lives without their disease worsening or death after commencing treatment.
 
This guide provides instructions on creating an `ADRS` dataset tailored for PFS parameters using packages from the pharmaverse along with some from tidyverse. `ADSL` and SDTM data is used as input. 

### Load Data and Required pharmaverse Packages
The packages below are required to construct an `ADRS` focusing on parameters that will be needed to construct a PFS time to event endpoint. Three further packages are used in this guide for working with metadata and validator applications. A brief description of their purpose is found below:

-   [`{metacore}`](https://atorus-research.github.io/metacore/): provides harmonized metadata/specifications object.
-   [`{metatools}`](https://pharmaverse.github.io/metatools/): uses the provided metadata to build/enhance and check the dataset.
-   [`{admiral}`](https://pharmaverse.github.io/admiral/index.html): provides the ADaM derivations.
-   [`{xportr}`](https://atorus-research.github.io/xportr/): delivers the SAS transport file (XPT) and eSub checks.

```{r, output=FALSE}
library(admiral)
library(admiralonco)
library(pharmaverseadam)
library(pharmaversesdtm)
library(dplyr)
library(metacore)
library(metatools)
library(xportr)
```

Data necessary for the analysis is loaded from the `{pharmaverseadam}` and `{pharmaversestdm}` packages. `adsl` contains subject-level data and `rs_onco_recist` holds oncology-specific response data. `RANDDT` (randomization date) is then merged  from `adsl` into `rs`, aligning data by study and subject identifiers. 

```{r}
data("adsl")
data("rs_onco_recist")

rs <- rs_onco_recist
rs <- convert_blanks_to_na(rs)

adsl_vars <- exprs(RANDDT)
adrs <- derive_vars_merged(
  rs,
  dataset_add = adsl,
  new_vars = adsl_vars,
  by_vars = exprs(STUDYID, USUBJID)
)
```

```{r, echo=FALSE}
head(adrs, n = 10)
```

### Preprocessing 
The data is filtered to include only investigators overall responses and new columns are added to categorize the type of response. Some minor modifications are made to rename `RSSTRESC` to `AVALC` and map character response values in `AVALC` to numeric in `AVAL`.
```{r}
adrs_ovr <- adrs |>
  filter(RSEVAL == "INVESTIGATOR" & RSTESTCD == "OVRLRESP") |>
  mutate(
    PARAMCD = "OVR",
    PARAM = "Overall Response by Investigator",
    PARCAT1 = "Tumor Response",
    PARCAT2 = "Investigator",
    PARCAT3 = "RECIST 1.1"
  )

adrs_rn <- adrs_ovr |>
  mutate(
    AVALC = RSSTRESC,
    AVAL = aval_resp(AVALC)
  )
```

```{r, echo=FALSE}
head(adrs_rn, n = 10)
```

### Handling Date Variables
Missing parts of dates are imputed, assuming the last possible date. Further information can be found in the `admiral` documentation [here](https://pharmaverse.github.io/admiral/reference/derive_vars_dt.html)

```{r}
adrs_dtpt <- adrs_rn |>
  derive_vars_dt(
    dtc = RSDTC,
    new_vars_prefix = "A",
    highest_imputation = "D",
    date_imputation = "last"
  ) |>
  mutate(AVISIT = VISIT)
```

```{r, echo=FALSE}
head(adrs_dtpt, n = 10)
```

### Applying the Worst Response Function
A function is constructed to rank responses from worst to best. The `admiral::derive_var_relative_flag()` function is then used to create a flag (`ANL01FL`) for the worst response at each date for further analysis, considering only valid assessments from the randomization date onwards. 

```{r}
worst_resp <- function(arg) {
  case_when(
    arg == "NE" ~ 1,
    arg == "CR" ~ 2,
    arg == "PR" ~ 3,
    arg == "SD" ~ 4,
    arg == "NON-CR/NON-PD" ~ 5,
    arg == "PD" ~ 6,
    TRUE ~ 0
  )
}

adrs_rk <- adrs_dtpt |>
  restrict_derivation(
    derivation = derive_var_extreme_flag,
    args = params(
      by_vars = exprs(STUDYID, USUBJID, ADT),
      order = exprs(worst_resp(AVALC), RSSEQ),
      new_var = ANL01FL,
      mode = "last"
    ),
    filter = !is.na(AVAL) & ADT >= RANDDT
  )
```

```{r, echo=FALSE}
head(adrs_rk, n = 10)
```

### Deriving Parameters for Progressive Disease
The first instance of disease progression for each subject is derived. This is specifically marked by the endpoint 'PD' (Progressive Disease). 
```{r}
adrs_fdp <- adrs_rk |>
  derive_extreme_records(
    dataset_ref = adsl,
    dataset_add = adrs_rk,
    by_vars = exprs(STUDYID, USUBJID),
    filter_add = PARAMCD == "OVR" & AVALC == "PD" & ANL01FL == "Y",
    order = exprs(ADT, RSSEQ),
    mode = "first",
    exist_flag = AVALC,
    false_value = "N",
    set_values_to = exprs(
      PARAMCD = "PD",
      PARAM = "Disease Progression by Investigator",
      PARCAT1 = "Tumor Response",
      PARCAT2 = "Investigator",
      PARCAT3 = "RECIST 1.1",
      AVAL = yn_to_numeric(AVALC),
      ANL01FL = "Y"
    )
  )
```

```{r, echo=FALSE}
head(adrs_fdp, n = 10)
```

### Deriving Last Disease Assessment Parameter
   
The `ADRS` dataset should include parameters that mark the last disease assessment for each subject. This can be achieved using `admiral::derive_extreme_records()`, which identifies the latest assessment based on specific conditions.
   
Here, we derive a new parameter for the last disease assessment.
   
```{r}
adrs_last <- adrs_fdp |>
 derive_extreme_records(
   dataset_ref = adsl,
   dataset_add = adrs_fdp,
   by_vars = exprs(STUDYID, USUBJID),
   filter_add = PARAMCD == "OVR" & ANL01FL == "Y",
   order = exprs(ADT, RSSEQ),
   mode = "last",
   set_values_to = exprs(
     PARAMCD = "LSTA",
     PARAM = "Last Disease Assessment by Investigator",
     PARCAT1 = "Tumor Response",
     PARCAT2 = "Investigator",
     PARCAT3 = "RECIST 1.1",
     ANL01FL = "Y"
   )
 )
```

```{r, echo=FALSE}
head(adrs_last, n = 10)
```

This parameter will provide critical information about the most recent evaluation of disease status for each patient.

### Handling Death Data
We next need to process the death data. The function `admiral::derive_extreme_records()` is used to identify a death event for each patient.
```{r}
adsldth <- adsl |>
  select(STUDYID, USUBJID, DTHDT, !!!adsl_vars)

adrs_de <- adrs_last |>
  derive_extreme_records(
    dataset_ref = adsldth,
    dataset_add = adsldth,
    by_vars = exprs(STUDYID, USUBJID),
    filter_add = !is.na(DTHDT),
    exist_flag = AVALC,
    false_value = "N",
    set_values_to = exprs(
      PARAMCD = "DEATH",
      PARAM = "Death",
      PARCAT1 = "Reference Event",
      AVAL = yn_to_numeric(AVALC),
      ANL01FL = "Y",
      ADT = DTHDT
    )
  ) |>
  select(-DTHDT)
```

```{r, echo=FALSE}
head(adrs_de, n = 10)
```

### Merging Additional ADSL Variables
Additional variables are merged from `adsl` into the dataset, enriching it with more subject-level details. 
```{r}
adrs_mrg <- adrs_de |>
  derive_vars_merged(
    dataset_add = select(adsl, !!!negate_vars(adsl_vars)),
    by_vars = exprs(STUDYID, USUBJID)
  )
```

### Result
We've successfully constructed our final `ADRS` dataset. Below, you can find a selection of columns that contain the most critical information.

```{r echo=FALSE}
adrs_mrg |> 
  select(PARAMCD, PARAM, PARCAT1, PARCAT2, PARCAT3,
         ADT, AVALC, AVAL, ANL01FL, RSDTC) |> head(n = 10)
```

In this dataset: 

- **PARAMCD**: Represents the parameter code, here "OVR" for "Overall Response", indicating the type of data recorded.
- **PARAM**: Describes the content of the record, specifically "Overall Response by Investigator", indicating it reflects the investigator's assessment of patient response.
- **PARCAT1**: Category of the parameter, "Tumor Response", classifying the type of outcome measured.
- **PARCAT2**: Indicates the assessor, here "Investigator", showing who evaluated the response.
- **PARCAT3**: Denotes the criteria used, "RECIST 1.1", which is a standard for assessing solid tumor response in trials.
- **ADT**: The actual date of the assessment, showing when each response was evaluated. 
